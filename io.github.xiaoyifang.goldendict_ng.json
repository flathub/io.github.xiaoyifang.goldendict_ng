{
    "app-id": "io.github.xiaoyifang.goldendict_ng",
    "runtime": "org.kde.Platform",
    "runtime-version": "6.6",
    "sdk": "org.kde.Sdk",
    "command": "goldendict",
    "base": "io.qt.qtwebengine.BaseApp",
    "base-version": "6.6",
    "add-extensions": {
        "org.freedesktop.Platform.ffmpeg-full": {
            "directory": "lib/ffmpeg",
            "add-ld-path": ".",
            "version": "23.08",
            "no-autodownload": true,
            "autodelete": false
        }
    },
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--device=dri",
        "--socket=pulseaudio",
        "--share=network",
        "--talk-name=org.freedesktop.Notifications",
        "--talk-name=org.kde.StatusNotifierWatcher"
    ],
    "modules": [
        {
            "name": "opencc",
            "buildsystem": "cmake-ninja",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/BYVoid/OpenCC.git",
                    "tag": "ver.1.1.7",
                    "commit": "e5d6c5f1b78e28a5797e7ad3ede3513314e544b7",
                    "x-checker-data": {
                        "type": "git",
                        "tag-pattern": "^ver.([\\d.]+)$",
                        "version-scheme": "semantic"
                    }
                }
            ]
        },
        {
            "name": "lzo2",
            "config-opts": [
                "--enable-shared",
                "--disable-static"
            ],
            "cleanup": [
                "/include",
                "/share/doc",
                "*.la",
                "/lib/*.so"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://www.oberhumer.com/opensource/lzo/download/lzo-2.10.tar.gz",
                    "sha256": "c0f892943208266f9b6543b3ae308fab6284c5c90e627931446fb49b4221a072",
                    "x-checker-data": {
                        "type": "anitya",
                        "project-id": 1868,
                        "url-template": "http://www.oberhumer.com/opensource/lzo/download/lzo-$version.tar.gz"
                    }
                }
            ]
        },
        {
            "name": "eb",
            "config-opts": [
                "--enable-shared",
                "--disable-static"
            ],
            "cleanup": [
                "/bin",
                "/share/doc"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://salsa.debian.org/debian/eb.git",
                    "tag": "debian/4.4.3-14",
                    "x-checker-data": {
                        "type": "git",
                        "tag-pattern": "^debian\\/4.4.3-(\\d+)$"
                    },
                    "commit": "58570b89141bd19684544b41efc94a3586adf0b9"
                },
                {
                    "type": "shell",
                    "commands": [
                        "cp -p /usr/share/automake-*/config.{sub,guess} ."
                    ]
                }
            ]
        },
        {
            "name": "xapian-core",
            "config-opts": [
                "--disable-sse",
                "--disable-backend-chert",
                "--disable-backend-remote",
                "--disable-documentation"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://oligarchy.co.uk/xapian/1.4.23/xapian-core-1.4.23.tar.xz",
                    "sha256": "30d3518172084f310dab86d262b512718a7f9a13635aaa1a188e61dc26b2288c"
                }
            ]
        },
        {
            "name": "libzim",
            "buildsystem": "meson",
            "builddir": true,
            "config-opts": [
                "--wrap-mode=nodownload",
                "-Dtest_data_dir=none"
            ],
            "cleanup": [
                "/bin",
                "/include",
                "/lib/pkgconfig"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/openzim/libzim.git",
                    "tag": "9.1.0",
                    "commit": "ff3f44d7e6685e92ec756d181df25889122f2154",
                    "x-checker-data": {
                        "type": "anitya",
                        "project-id": 20193,
                        "tag-template": "$version"
                    }
                }
            ]
        },
        {
            "name": "goldendict-ng",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DWITH_XAPIAN=ON",
                "-DWITH_ZIM=ON",
                "-DWITH_FFMPEG_PLAYER=ON",
                "-DWITH_EPWING_SUPPORT=ON"
            ],
            "build-commands": [
                "mkdir -p /app/lib/ffmpeg",
                "install -Dm644 redist/icons/goldendict.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png",
                "desktop-file-edit --set-icon \"${FLATPAK_ID}\" redist/${FLATPAK_ID}.desktop",
                "sed --in-place \"44i <releases> <release version=\\\"`date +%y.%m.%d`\\\" date=\\\"`date --iso-8601`\\\"/> </releases>\" redist/io.github.xiaoyifang.goldendict_ng.metainfo.xml"
            ],
            "cleanup": [
                "/share/pixmaps"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/xiaoyifang/goldendict-ng/",
                    "commit": "b0086d5c2df2d9c52d005cd51ab2505ebff78d09",
                    "x-checker-data": {
                        "type": "json",
                        "url": "https://api.github.com/repos/xiaoyifang/goldendict-ng/releases/latest",
                        "tag-query": ".tag_name",
                        "version-query": ".tag_name | sub(\"^v(?<version_str>[\\\\d.]*)-.*\"; \"\\(.version_str)\")"
                    },
                    "tag": "v23.12.07-HeavySnow.b0086d5c"
                }
            ]
        }
    ]
}
